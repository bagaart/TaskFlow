<!-- task_create.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow - Главная</title>
    <link rel="stylesheet" href="../static/styles/task_create.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
   <link
     href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
     rel="stylesheet"
   />
   <link
     rel="stylesheet"
     href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
   />
</head>
<body>
    <header class="header">
        <a class="logo" href="{{ url_for('taskflow.index') }}"><span>TaskFlow</span></a>
    </header>

    <aside class="sidebar">
        <ul class="nav-menu">
            <li><a href="#"><img class="icon" src="https://img.icons8.com/windows/32/search--v1.png" alt="search--v1"/>Поиск</a></li>
            <li><a href="{{ url_for('taskflow.tasks') }}"><img class="icon" src="https://img.icons8.com/windows/32/todo-list.png" alt="todo-list"/>Задачи</a></li>
            <li><a href="{{ url_for('taskflow.projects') }}"><img class="icon" src="https://img.icons8.com/windows/32/flipboard.png" alt="flipboard"/>Проекты</a></li>
            <li><a href="#"><img class="icon" src="https://img.icons8.com/windows/32/gender-neutral-user.png" alt="gender-neutral-user"/>Профиль</a></li>

            <li><a href="{{ url_for('taskflow.create_task') }}" class="create-task"><img class="icon" src="https://img.icons8.com/windows/32/plus-math.png" alt="plus-math"/>Создать задачу</a></li>

            <li><a href="{{ url_for('taskflow.create_project') }}" class="create-task"><img class="icon" src="https://img.icons8.com/windows/32/plus-math.png" alt="plus-math"/>Создать проект</a></li>
        </ul>

        <ul class="nav-menu bottom-menu">
            <li><a href="#"><img class="icon" src="https://img.icons8.com/windows/32/help.png" alt="help"/>Помощь</a></li>
            <li><a href="#"><img class="icon" src="https://img.icons8.com/windows/32/settings--v1.png" alt="settings--v1"/>Настройки</a></li>
            <li><a href="{{ url_for('taskflow.logout') }}"><img class="icon" src="https://img.icons8.com/windows/32/exit.png" alt="exit"/>Выход</a></li>
        </ul>
    </aside>

<main class="main-content">
    <div class="create-task-header">
        <h1>Создать задачу</h1>
    </div>

    <div class="task-form-container">
        <form class="task-form" id="taskForm" method="POST" action="{{ url_for('taskflow.create_task') }}">
            <!-- Название задачи -->
            <div class="form-group">
                <label for="task-name">Название задачи*</label>
                <input type="text" id="task-name" name="task-name" class="form-control" placeholder="Введите название задачи" required>
            </div>

            <!-- Проект -->
            <div class="form-group">
                <label for="project">Проект*</label>
                <select id="project" class="form-control" name="project" required>
                    <option value="" disabled selected>Выберите проект</option>
                    {% for project in user_projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Исполнители -->
            <div class="form-group">
                <label>Исполнители*</label>
                <div class="participants-container">
                    <input type="text" id="participant-search" placeholder="Выбранные исполнители" class="form-control" disabled>
                    <button type="button" class="btn-add btn-add-participant" onclick="openExecutorModal()">+ Добавить исполнителя</button>
                    <ul id="executor-list" class="selected-users participant-chips"></ul>
                </div>
            </div>

            <!-- Срок выполнения -->
            <div class="form-group">
                <label for="deadline">Срок выполнения*</label>
                <input type="date" id="deadline" class="form-control" name="deadline" required>
            </div>

            <!-- Описание задачи -->
            <div class="form-group">
                <label for="description">Описание задачи</label>
                <textarea id="description" class="form-control" name="description" rows="5"
                          placeholder="Опишите задачу подробнее..."></textarea>
            </div>

            <!-- Кнопки -->
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="window.history.back()">Отмена</button>
                <button type="submit" class="btn-create">Создать задачу</button>
            </div>
        </form>
    </div>
</main>

<!-- Modal для выбора исполнителей -->
<div id="executorModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeExecutorModal()">&times;</span>
        <h2>Добавить исполнителей</h2>
        <input type="text" id="user-search" placeholder="Поиск по имени или email..." />
        <ul id="user-list" class="user-list"></ul>
        <button class="btn-add btn-confirm" onclick="addSelectedExecutors()">Добавить</button>
    </div>
</div>

<script>
let selectedExecutors = [];

function openExecutorModal() {
    document.getElementById('executorModal').style.display = 'block';
}
function closeExecutorModal() {
    document.getElementById('executorModal').style.display = 'none';
}

document.getElementById('user-search').addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const items = document.querySelectorAll('#user-list li');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(filter) ? 'block' : 'none';
    });
});

// Загрузка участников проекта при выборе
document.getElementById('project').addEventListener('change', function () {
    const projectId = this.value;
    if (!projectId) return;

    fetch(`/api/project/${projectId}/participants`)
        .then(res => res.json())
        .then(data => {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            data.participants.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <label>
                        <input type="checkbox" value="${p.id}" data-name="${p.name}">
                        ${p.name} <${p.email}>
                    </label>
                `;
                userList.appendChild(li);
            });
        });
});

function addSelectedExecutors() {
    const checkboxes = document.querySelectorAll('#user-list input[type=checkbox]:checked');
    checkboxes.forEach(cb => {
        const id = cb.value;
        const name = cb.getAttribute('data-name');
        if (!selectedExecutors.some(e => e.id === id)) {
            selectedExecutors.push({id, name});
        }
        cb.checked = false;
    });
    updateExecutorChips();
    closeExecutorModal();
}

function updateExecutorChips() {
    const container = document.getElementById('executor-list');
    container.innerHTML = '';
    selectedExecutors.forEach((e, index) => {
        const li = document.createElement('li');
        li.className = 'selected-user';
        li.textContent = e.name;
        const removeBtn = document.createElement('span');
        removeBtn.textContent = ' ×';
        removeBtn.style.color = 'red';
        removeBtn.style.cursor = 'pointer';
        removeBtn.onclick = () => {
            selectedExecutors.splice(index, 1);
            updateExecutorChips();
        };
        li.appendChild(removeBtn);
        container.appendChild(li);
    });
}

// Установка минимальной даты
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('deadline').setAttribute('min', today);
});

// Отправка формы
document.getElementById('taskForm').onsubmit = function (e) {
    e.preventDefault();

    const formData = new FormData(this);

    // Добавляем ID исполнителей
    selectedExecutors.forEach(e => {
        formData.append("executors", e.id);
    });

    // Отправка
    fetch(this.action, {
        method: "POST",
        body: formData
    }).then(res => {
        if (res.redirected) window.location.href = res.url;
    });
};
</script>
</body>
</html>